<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music Player</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽµ</text></svg>">
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    .container {
      text-align: center;
    }
    .status {
      font-size: 24px;
      margin-bottom: 20px;
    }
    .audio-visualization {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      height: 100px;
      margin-top: 30px;
      gap: 3px;
    }
    .bar {
      width: 10px;
      background-color: #4CAF50;
      margin: 0 2px;
      border-radius: 3px;
      transition: height 0.1s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Music Player</h1>
    <div class="status" id="statusText">Disconnected</div>
    <div class="audio-visualization" id="visualization">
      <!-- Bars will be generated by JavaScript -->
    </div>
    <button id="activateButton" style="padding: 10px 20px; margin: 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">Click to Activate Audio</button>
    <audio id="audioPlayer" loop>
      <source src="/audio/paradise.mp3" type="audio/mpeg">
      <source src="/audio/magicloop.mp3" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // DOM elements
    const audioPlayer = document.getElementById('audioPlayer');
    const statusText = document.getElementById('statusText');
    const visualization = document.getElementById('visualization');
    const activateButton = document.getElementById('activateButton');
    
    // Create visualization bars
    const barCount = 30;
    for (let i = 0; i < barCount; i++) {
      const bar = document.createElement('div');
      bar.className = 'bar';
      bar.style.height = '0px';
      visualization.appendChild(bar);
    }
    const bars = document.querySelectorAll('.bar');
    
    // Audio state
    let isPlaying = false;
    let audioActivated = false;
    let shouldBePlayingAudio = false;
    
    // Socket connection
    let socket;
    
    // Add click handler for activation button
    activateButton.addEventListener('click', () => {
      audioActivated = true;
      activateButton.style.display = 'none';
      
      // Play a silent sound to activate audio
      audioPlayer.volume = 0;
      audioPlayer.play().then(() => {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        audioPlayer.volume = 1;
        statusText.textContent = 'Audio Activated - Waiting for commands';
        
        // Check if we should be playing audio (in case we received a command while audio was not yet activated)
        if (shouldBePlayingAudio) {
          startAudio();
        }
      }).catch(err => {
        console.error('Error activating audio:', err);
        statusText.textContent = 'Error Activating Audio';
      });
    });
    
    // Connect to Socket.IO server
    function connectSocket() {
      // Get the current page URL to handle connecting from different devices
      const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
      const host = window.location.hostname;
      const port = window.location.port ? `:${window.location.port}` : '';
      const serverUrl = `${protocol}//${host}${port}`;
      
      // Connect with explicit URL and options
      socket = io(serverUrl, {
        transports: ['websocket', 'polling'],
        reconnectionAttempts: 5,
        reconnectionDelay: 1000,
        timeout: 20000
      });
      
      // Fetch current server state
      fetch('/api/state')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.state) {
            // Check if music should be playing
            if (data.state.musicEnabled !== undefined && data.state.musicEnabled) {
              shouldBePlayingAudio = true;
              if (audioActivated) {
                startAudio();
              } else {
                statusText.textContent = 'Click Activate Button to Start Music';
              }
            }
          }
        })
        .catch(error => {
          console.error('Error fetching server state:', error);
        });

      // Connection established
      socket.on('connect', () => {
        statusText.textContent = 'Connected - Waiting for commands';
        
        // Send a message to indicate this is the music client
        socket.emit('test-message', { client: 'music', timestamp: Date.now() });
      });
      
      // Connection lost
      socket.on('disconnect', () => {
        statusText.textContent = 'Disconnected';
        stopAudio();
      });
      
      // Connection error
      socket.on('connect_error', (error) => {
        statusText.textContent = 'Connection Error';
        stopAudio();
      });
      
      // Listen for tree commands
      socket.on('tree-update', (command) => {
        if (command.type === 'toggleMusic') {
          if (command.enabled) {
            shouldBePlayingAudio = true;
            if (audioActivated) {
              startAudio();
            } else {
              statusText.textContent = 'Click Activate Button to Start Music';
            }
          } else {
            shouldBePlayingAudio = false;
            stopAudio();
          }
        }
      });
      
      // Also listen for button-event messages to update UI
      socket.on('button-event', (data) => {
        if (data && data.message) {
          // Check if the message is related to music
          if (data.message.toLowerCase().includes('music')) {
            // Update status text to reflect the event
            const statusMsg = document.createElement('div');
            statusMsg.textContent = data.message;
            statusMsg.style.fontSize = '16px';
            statusMsg.style.color = '#999';
            statusMsg.style.marginTop = '10px';
            
            // Add to the status area temporarily
            document.querySelector('.container').appendChild(statusMsg);
            
            // Remove after a few seconds
            setTimeout(() => {
              statusMsg.style.opacity = '0';
              statusMsg.style.transition = 'opacity 1s';
              setTimeout(() => statusMsg.remove(), 1000);
            }, 5000);
          }
        }
      });
      
      // Add a pinger to keep connection alive
      setInterval(() => {
        if (socket && socket.connected) {
          socket.emit('ping', { timestamp: Date.now() });
        }
      }, 30000);
    }
    
    // Start playing audio
    function startAudio() {
      if (!isPlaying && audioActivated) {
        audioPlayer.play().then(() => {
          isPlaying = true;
          statusText.textContent = 'Playing Music';
          startVisualization();
        }).catch(err => {
          console.error('Error playing audio:', err);
          statusText.textContent = 'Error Playing Music';
          
          // If we fail to play, suggest user click again
          activateButton.style.display = 'block';
          activateButton.textContent = 'Try Again';
          audioActivated = false;
        });
      } else if (!audioActivated) {
        // Remind user to activate audio
        activateButton.style.display = 'block';
        statusText.textContent = 'Click to Activate Audio';
      }
    }
    
    // Stop playing audio
    function stopAudio() {
      if (isPlaying) {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        isPlaying = false;
        statusText.textContent = 'Connected - Music Stopped';
        stopVisualization();
      }
    }
    
    // Basic audio visualization
    let visualizationInterval;
    
    function startVisualization() {
      stopVisualization();
      visualizationInterval = setInterval(() => {
        bars.forEach(bar => {
          const height = isPlaying ? Math.floor(Math.random() * 100) : 0;
          bar.style.height = `${height}px`;
        });
      }, 100);
    }
    
    function stopVisualization() {
      if (visualizationInterval) {
        clearInterval(visualizationInterval);
        bars.forEach(bar => {
          bar.style.height = '0px';
        });
      }
    }
    
    // Initialize the page
    connectSocket();
  </script>
</body>
</html>